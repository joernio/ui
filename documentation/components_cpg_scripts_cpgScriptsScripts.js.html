<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/cpg_scripts/cpgScriptsScripts.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/cpg_scripts/cpgScriptsScripts.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import {
	getDirectories,
	readFile,
	openFile,
	deleteFile,
	generateScriptImportQuery,
	handleSetToast,
	getUIIgnoreArr,
} from '../../assets/js/utils/scripts';
import { selectDirApi } from '../../assets/js/utils/ipcRenderer';

export const handleToggleScriptsVisible = scriptsVisible => ({
	scriptsVisible: !scriptsVisible,
});

/**
 * Funciton to toggle scripts dialog
 * @param {*} bool
 * @returns true or false
 */
export const toggleScriptsArgsDialog = bool => {
  console.log('toggleScriptsArgsDialog: ', bool);
  return { openDialog: !bool };
};

/**
 * Function to add to script
 * @param {*} query
 * @param {*} props
 */
export const addToScriptsQueue = (query, props) => {
	props.enQueueScriptsQuery(query);
};

export const extractScriptTagName = data =>
	data.split('&lt;tag>')[1].split('&lt;/tag>')[0];

export const formatArgs = args => {
	if (args.length &lt; 1) {
		return args.join(',');
	}
	args = args.map(arg => (Number.isNaN(Number(arg)) ? `"${arg}"` : arg));
	return args.join(',');
};

export const organisedScriptsToScripts = organised_scripts => {
	const scripts = {};

	Object.keys(organised_scripts).forEach(key => {
		if (organised_scripts[key].tag !== true) {
			scripts[key] = organised_scripts[key];
		} else if (organised_scripts[key].tag === true) {
			Object.keys(organised_scripts[key]).forEach(path => {
				if (organised_scripts[key][path] !== true) {
					scripts[path] = organised_scripts[key][path];
				}
			});
		}
	});

	return scripts;
};

export const deleteSelected = async selected => {
	const paths = Object.keys(selected);

	for (let i = 0; i &lt; paths.length; i += 1) {
		// await in for loop is an indication that something is wrong,
		// but it will be like this for now until we find a better way.
		await deleteFile(paths[i]); // eslint-disable-line no-await-in-loop
		await new Promise(r => setTimeout(r, 50)); // eslint-disable-line no-await-in-loop
	}
};

export const deleteAll = scripts => {
	const selected = organisedScriptsToScripts(scripts);
	deleteSelected(selected);
};

export const chokidarVars = {
	chokidarWatcher: null,
	chokidarConfig: (src, ignore) => ({
		ignored: [...getUIIgnoreArr(src, ignore)],
		awaitWriteFinish: {
			stabilityThreshold: 2000,
			pollInterval: 100,
		},
		ignorePermissionErrors: true,
	}),
};

export const extractScriptMainFunctionNameAndArgs = data => {
	let mainFunctionArgs;
	let mainFunctionName = data.split('@main')[1].split('def')[1];
	mainFunctionName = mainFunctionName.trim();
	[mainFunctionName, mainFunctionArgs] = mainFunctionName.split('(');
	mainFunctionArgs = mainFunctionArgs.split(')')[0];
	mainFunctionArgs = mainFunctionArgs
		.split(',')
		.filter(arg => !!(arg &amp;&amp; arg !== ' '))
		.map(arg => arg.split(':')[0].trim());

	return [mainFunctionName, mainFunctionArgs];
};

export const getCpgScripts = async props => {
	const path = props.settings.scriptsDir;

	if (path) {
		const scripts = {};
		const organised_scripts = {};

		const scriptsArr = await getDirectories(path).then(paths =>
			paths.filter(path => !!path.endsWith('.sc')),
		);

		await Promise.all(
			scriptsArr.map(path =>
				readFile(path).then(data => {
					let tag;
					let mainFunctionName;
					let mainFunctionArgs;

					if (data.search(/\/\/&lt;tag>(.*?)&lt;\/tag>/g) > -1) {
						tag = extractScriptTagName(data);
					}

					if (data.search(/^(?:\s*)@main|(?:\n\s*)@main/) > -1) {
						[mainFunctionName, mainFunctionArgs] =
							extractScriptMainFunctionNameAndArgs(data);
						scripts[path] = {
							tag,
							mainFunctionName,
							mainFunctionArgs,
						};
					}
				}),
			),
		);

		Object.keys(scripts).forEach(path => {
			if (scripts[path].tag &amp;&amp; scripts[path].tag !== ' ') {
				const { tag } = scripts[path];
				const { mainFunctionName } = scripts[path];
				const { mainFunctionArgs } = scripts[path];
				organised_scripts[tag] =
					organised_scripts[tag] === Object(organised_scripts[tag])
						? {
								...organised_scripts[tag],
								[path]: { mainFunctionName, mainFunctionArgs },
						  }
						: {
								tag: true,
								[path]: { mainFunctionName, mainFunctionArgs },
						  };
			}
		});

		Object.keys(scripts).forEach(path => {
			if (!scripts[path].tag || scripts[path].tag === ' ') {
				const { mainFunctionName } = scripts[path];
				const { mainFunctionArgs } = scripts[path];
				organised_scripts[path] = {
					mainFunctionName,
					mainFunctionArgs,
				};
			}
		});

		return organised_scripts;
	}
};

export const collectArgsValues = (dialogEl, dialogFields) => {
	dialogFields = dialogFields.map(script => ({
		path: script.path,
		filename: script.filename,
		mainFunctionName: script.mainFunctionName,
		mainFunctionArgs: script.mainFunctionArgs.map(arg => {
			const { value } = dialogEl.current.querySelector(
				`#${script.filename.replaceAll('.', '-')}-${
					script.mainFunctionName
				}-${arg}`,
			);
			return value;
		}),
	}));
	return dialogFields;
};

export const runScript = async (path, args, mainFunctionName, props) => {
	const workspace_path = props.workspace.path;
	if (path &amp;&amp; workspace_path) {
		openFile(path);

		const query_string = await generateScriptImportQuery(
			path,
			workspace_path,
		);

		if (query_string) {
			let filename = query_string.split('.');
			filename = filename[filename.length - 1];

			const importScriptQuery = {
				query: query_string,
				origin: 'script',
				ignore: true,
			};

			const runScriptQuery = {
				query: `${filename}.${mainFunctionName}(${formatArgs(args)})`,
				origin: 'script',
				ignore: true,
			};

			addToScriptsQueue(importScriptQuery, props);
			addToScriptsQueue(runScriptQuery, props);
			handleSetToast({
				icon: 'info-sign',
				intent: 'success',
				message: 'script running ...',
			});
		} else {
			handleSetToast({
				icon: 'warning-sign',
				intent: 'danger',
				message: 'an error occured while running script',
			});
		}
	} else {
		handleSetToast({
			icon: 'warning-sign',
			intent: 'danger',
			message: 'an error occured while running script',
		});
	}
};

export const handleCPGScriptTagClick = (e, value, scripts, selected) => {
	const tag_scripts_paths = Object.keys(scripts[value]);
	if (Array.isArray(tag_scripts_paths) &amp;&amp; tag_scripts_paths.length > 1) {
		openFile(tag_scripts_paths[1]);

		if (!e.ctrlKey) {
			selected = {};
		}

		tag_scripts_paths.forEach(path => {
			if (scripts[value][path] !== true) {
				selected[path] = true;
			}
		});

		return { selected };
	}
};

export const mainScriptsFunctionsTakeArgs = (pathsArr, organised_scripts) => {
	let scripts = {};
	let takesArgs = false;

	scripts = organisedScriptsToScripts(organised_scripts);

	pathsArr.forEach(path => {
		if (scripts[path].mainFunctionArgs.length > 0) {
			takesArgs = true;
		}
	});

	return takesArgs;
};

export const populateArgsDialogFields = (pathsArr, organised_scripts) => {
	let scripts = {};
	const fieldsArr = [];

	scripts = organisedScriptsToScripts(organised_scripts);

	pathsArr.forEach(path => {
		if (scripts[path]) {
			let filename = path.split('/');
			filename = filename[filename.length - 1];

			fieldsArr.push({
				path,
				filename,
				mainFunctionName: scripts[path].mainFunctionName,
				mainFunctionArgs: [...scripts[path].mainFunctionArgs],
			});
		}
	});

	return fieldsArr;
};

export const runSelected = async (
	dialogFields,
	selected,
	organised_scripts,
	props,
) => {
	const paths = Object.keys(selected);
	const scripts = organisedScriptsToScripts(organised_scripts);
	const promises = [];

	for (let i = 0; i &lt; paths.length; i += 1) {
		const args = dialogFields.filter(script => script.path === paths[i])[0]
			?.mainFunctionArgs;
		const { mainFunctionName } = scripts[paths[i]];
		promises.push(runScript(paths[i], args || [], mainFunctionName, props));
	}

	await Promise.all(promises);
};

export const handleRun = (selected, scripts, props) => {
	if (mainScriptsFunctionsTakeArgs(Object.keys(selected), scripts)) {
		return {
			dialogFields: populateArgsDialogFields(
				Object.keys(selected),
				scripts,
			),
			openDialog: true,
			selected,
		};
	}
	runSelected([], selected, scripts, props);
	return { selected };
};

export const switchDefaultScriptsFolder = async props => {
	selectDirApi.selectDir('select-dir');

	const path = await new Promise((resolve, reject) => {
		selectDirApi.registerListener('selected-dir', value => {
			if (value) {
				resolve(value);
			} else {
				reject();
			}
		});
	}).catch(() => {
		console.log("can't select scripts path"); // eslint-disable-line no-console
	});

	if (path) {
		const values = JSON.parse(JSON.stringify(props.settings));
		values.scriptsDir = path;
		props.setSettings(values);
	}
};

// export const readFirstLine = path => {
//   return new Promise((resolve, reject) => {
//     let rs = fs.createReadStream(path, { encoding: 'utf8' });
//     let acc = '';
//     let pos = 0;
//     let index;
//     rs.on('data', chunk => {
//       index = chunk.indexOf('\n');
//       acc += chunk;
//       index !== -1 ? rs.close() : (pos += chunk.length);
//     })
//       .on('close', () => {
//         resolve(acc.slice(0, pos + index));
//       })
//       .on('error', err => {
//         reject(err);
//       });
//   });
// };
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Global</h3><ul><li><a href="global.html#addRemoveKeyDownKeyUpEvent">addRemoveKeyDownKeyUpEvent</a></li><li><a href="global.html#addToQueue">addToQueue</a></li><li><a href="global.html#addToScriptsQueue">addToScriptsQueue</a></li><li><a href="global.html#areResultsEqual">areResultsEqual</a></li><li><a href="global.html#closeDialog">closeDialog</a></li><li><a href="global.html#closeFile">closeFile</a></li><li><a href="global.html#collectSettingsValues">collectSettingsValues</a></li><li><a href="global.html#constructInputToWrite">constructInputToWrite</a></li><li><a href="global.html#constructOutputToWrite">constructOutputToWrite</a></li><li><a href="global.html#contructQueryWithPath">contructQueryWithPath</a></li><li><a href="global.html#countQueries">countQueries</a></li><li><a href="global.html#createFolderJsonModel">createFolderJsonModel</a></li><li><a href="global.html#discardDialogHandler">discardDialogHandler</a></li><li><a href="global.html#editorDidMount">editorDidMount</a></li><li><a href="global.html#editorShouldGoToLine">editorShouldGoToLine</a></li><li><a href="global.html#extractLanguageFromString">extractLanguageFromString</a></li><li><a href="global.html#extractWorkSpaceNameAndActiveProject">extractWorkSpaceNameAndActiveProject</a></li><li><a href="global.html#forEachNode">forEachNode</a></li><li><a href="global.html#forNodeAtPath">forNodeAtPath</a></li><li><a href="global.html#fsToJson">fsToJson</a></li><li><a href="global.html#generateScriptImportQuery">generateScriptImportQuery</a></li><li><a href="global.html#getEditorFilesFromOpenFiles">getEditorFilesFromOpenFiles</a></li><li><a href="global.html#getExtension">getExtension</a></li><li><a href="global.html#getFolderStructureRootPathFromWorkspace">getFolderStructureRootPathFromWorkspace</a></li><li><a href="global.html#getOpenFileName">getOpenFileName</a></li><li><a href="global.html#getResultObjWithPostQueryKey">getResultObjWithPostQueryKey</a></li><li><a href="global.html#getRoot">getRoot</a></li><li><a href="global.html#getScriptResult">getScriptResult</a></li><li><a href="global.html#getSettingsInitialValues">getSettingsInitialValues</a></li><li><a href="global.html#getUIIgnoreArr">getUIIgnoreArr</a></li><li><a href="global.html#getWindowHeight">getWindowHeight</a></li><li><a href="global.html#goToLine">goToLine</a></li><li><a href="global.html#handleAddQueryToHistory">handleAddQueryToHistory</a></li><li><a href="global.html#handleAPIQueryError">handleAPIQueryError</a></li><li><a href="global.html#handleCloseProject">handleCloseProject</a></li><li><a href="global.html#handleDeleteProject">handleDeleteProject</a></li><li><a href="global.html#handleDiscard">handleDiscard</a></li><li><a href="global.html#handleEditorOnChange">handleEditorOnChange</a></li><li><a href="global.html#handleEmptyWorkspace">handleEmptyWorkspace</a></li><li><a href="global.html#handleFontSizeChange">handleFontSizeChange</a></li><li><a href="global.html#handleInitialTableWidth">handleInitialTableWidth</a></li><li><a href="global.html#handleInsertELementToCircuitUIResponseNode">handleInsertELementToCircuitUIResponseNode</a></li><li><a href="global.html#handleMaximize">handleMaximize</a></li><li><a href="global.html#handleMouseDown">handleMouseDown</a></li><li><a href="global.html#handleMouseOut">handleMouseOut</a></li><li><a href="global.html#handleMouseOver">handleMouseOver</a></li><li><a href="global.html#handleMove">handleMove</a></li><li><a href="global.html#handleOnChange">handleOnChange</a></li><li><a href="global.html#handleOpenFile">handleOpenFile</a></li><li><a href="global.html#handleOpenProject">handleOpenProject</a></li><li><a href="global.html#handleResize">handleResize</a></li><li><a href="global.html#handleSave">handleSave</a></li><li><a href="global.html#handleScrollTop">handleScrollTop</a></li><li><a href="global.html#handleShortcut">handleShortcut</a></li><li><a href="global.html#handleSuggestionClick">handleSuggestionClick</a></li><li><a href="global.html#handleSwitchWorkspace">handleSwitchWorkspace</a></li><li><a href="global.html#handleTerminalToggle">handleTerminalToggle</a></li><li><a href="global.html#handleToggleAllBlocks">handleToggleAllBlocks</a></li><li><a href="global.html#handleToggleAllSubBlocks">handleToggleAllSubBlocks</a></li><li><a href="global.html#handleToggleBlock">handleToggleBlock</a></li><li><a href="global.html#handleToggleSubBlock">handleToggleSubBlock</a></li><li><a href="global.html#handleWebSocketResponse">handleWebSocketResponse</a></li><li><a href="global.html#handleWriteQuery">handleWriteQuery</a></li><li><a href="global.html#handleWriteQueryResult">handleWriteQueryResult</a></li><li><a href="global.html#handleWriteScriptQuery">handleWriteScriptQuery</a></li><li><a href="global.html#handleWriteToCircuitUIInput">handleWriteToCircuitUIInput</a></li><li><a href="global.html#handleWriteToCircuitUIResponse">handleWriteToCircuitUIResponse</a></li><li><a href="global.html#highlightRange">highlightRange</a></li><li><a href="global.html#initCircuitUI">initCircuitUI</a></li><li><a href="global.html#initShortcuts">initShortcuts</a></li><li><a href="global.html#initXterm">initXterm</a></li><li><a href="global.html#isCtrlKeyPressed">isCtrlKeyPressed</a></li><li><a href="global.html#isCtrlKeyUnpressed">isCtrlKeyUnpressed</a></li><li><a href="global.html#isFilePathInQueryResult">isFilePathInQueryResult</a></li><li><a href="global.html#isLineNumberInQueryResult">isLineNumberInQueryResult</a></li><li><a href="global.html#isQueryResultToOpenSynthFile">isQueryResultToOpenSynthFile</a></li><li><a href="global.html#isScriptQueryResultToOpenSynthFile">isScriptQueryResultToOpenSynthFile</a></li><li><a href="global.html#modifyWorkSpaceNameAndActiveProject">modifyWorkSpaceNameAndActiveProject</a></li><li><a href="global.html#mouseTrapGlobalBindig">mouseTrapGlobalBindig</a></li><li><a href="global.html#nFormatter">nFormatter</a></li><li><a href="global.html#openEmptyFile">openEmptyFile</a></li><li><a href="global.html#openProjectExists">openProjectExists</a></li><li><a href="global.html#openShortcutsPage">openShortcutsPage</a></li><li><a href="global.html#openSyntheticFile">openSyntheticFile</a></li><li><a href="global.html#parseKeyBinding">parseKeyBinding</a></li><li><a href="global.html#parseProject">parseProject</a></li><li><a href="global.html#parseProjects">parseProjects</a></li><li><a href="global.html#parseScriptReportJSON">parseScriptReportJSON</a></li><li><a href="global.html#performDeQueueQuery">performDeQueueQuery</a></li><li><a href="global.html#performEnQueueQuery">performEnQueueQuery</a></li><li><a href="global.html#performPeekQueue">performPeekQueue</a></li><li><a href="global.html#performPostQuery">performPostQuery</a></li><li><a href="global.html#performPushResult">performPushResult</a></li><li><a href="global.html#processFiles">processFiles</a></li><li><a href="global.html#processQueryResult">processQueryResult</a></li><li><a href="global.html#processScriptResult">processScriptResult</a></li><li><a href="global.html#refreshOpenFiles">refreshOpenFiles</a></li><li><a href="global.html#registerQueryShortcut">registerQueryShortcut</a></li><li><a href="global.html#removeShortcuts">removeShortcuts</a></li><li><a href="global.html#resizeHandler">resizeHandler</a></li><li><a href="global.html#runQueryWithArgs">runQueryWithArgs</a></li><li><a href="global.html#saveFile">saveFile</a></li><li><a href="global.html#selectFolderStructureRootPath">selectFolderStructureRootPath</a></li><li><a href="global.html#sendQueryResultToXTerm">sendQueryResultToXTerm</a></li><li><a href="global.html#sendWindowsMessage">sendWindowsMessage</a></li><li><a href="global.html#setQueryResult">setQueryResult</a></li><li><a href="global.html#setSuggestionBoxTrackerContent">setSuggestionBoxTrackerContent</a></li><li><a href="global.html#shouldAlertScriptRunSuccessful">shouldAlertScriptRunSuccessful</a></li><li><a href="global.html#shouldProcessQueryResult">shouldProcessQueryResult</a></li><li><a href="global.html#shouldRunQuery">shouldRunQuery</a></li><li><a href="global.html#shouldSwitchFolder">shouldSwitchFolder</a></li><li><a href="global.html#suggestQueryForXterm">suggestQueryForXterm</a></li><li><a href="global.html#suggestSimilarQueries">suggestSimilarQueries</a></li><li><a href="global.html#toggleScriptsArgsDialog">toggleScriptsArgsDialog</a></li><li><a href="global.html#unRegisterQueryShortcut">unRegisterQueryShortcut</a></li><li><a href="global.html#updateCursorPosition">updateCursorPosition</a></li><li><a href="global.html#updateData">updateData</a></li><li><a href="global.html#updateQueriesStats">updateQueriesStats</a></li><li><a href="global.html#withAPI">withAPI</a></li><li><a href="global.html#wsDisconnectFromServer">wsDisconnectFromServer</a></li><li><a href="global.html#wsReconnectToServer">wsReconnectToServer</a></li><li><a href="global.html#zoomIn">zoomIn</a></li><li><a href="global.html#zoomOut">zoomOut</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc/jsdoc">JSDoc 3.6.10</a> on Wed Apr 20 2022 13:38:41 GMT-0700 (Pacific Daylight Time)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
